# PCM to WAV Service Architecture

## 1. Project Summary

The `pcm-to-wav-service` is a Go microservice that operates within the Book Expert ecosystem. Its primary function is to convert Pulse-Code Modulation (PCM) audio data, retrieved from a NATS JetStream object store, into the WAV audio format using the `sox` command-line tool. Upon successful conversion, the resulting WAV file is stored back into a NATS JetStream object store, and a `WavFileCreatedEvent` is published to a NATS subject.

## 2. Detailed Description

This service acts as a crucial processing step in the audio pipeline, transforming raw PCM audio chunks (generated by a Text-to-Speech service) into a more universally compatible WAV format. It is designed to be event-driven, reacting to `AudioChunkCreatedEvent` messages. The service ensures reliable message processing through NATS, robust file handling with JetStream object storage, and leverages an external, high-performance audio conversion utility (`sox`).

### Key Features:
-   **Event-Driven Processing**: Subscribes to NATS for `AudioChunkCreatedEvent` messages.
-   **NATS JetStream Object Storage**: Utilizes JetStream buckets for both input (PCM) and output (WAV) audio files.
-   **External Tool Integration**: Employs the `sox` command-line tool for efficient and high-quality audio format conversion.
-   **Event Publication**: Responds with a `WavFileCreatedEvent` message upon successful conversion, using the NATS request-reply pattern.
-   **Robust Error Handling**: If an error occurs during processing, the service logs the error and does not send a reply. The original requester is expected to handle this lack of response (e.g., with a timeout).

## 3. Technology Stack

-   **Programming Language**: Go (version 1.25.1 as per `go.mod`)
-   **Messaging**: NATS (client `github.com/nats-io/nats.go`)
-   **Object Storage**: NATS JetStream
-   **Audio Conversion**: `sox` command-line tool
-   **Libraries**:
    -   `github.com/book-expert/configurator`: For loading service configuration.
    -   `github.com/book-expert/events`: For standardized event definitions.
    -   `github.com/book-expert/logger`: For structured logging.
    -   `github.com/google/uuid`: For generating unique identifiers.
    -   `github.com/stretchr/testify`: For testing utilities.

## 4. Architectural Components

The `pcm-to-wav-service` is structured into several internal packages, promoting modularity and separation of concerns:

### `cmd/pcm-to-wav-service/main.go`
-   **Purpose**: The main entry point of the service.
-   **Responsibilities**:
    -   Initializes the logger.
    -   Loads service configuration using the `configurator` library.
    -   Establishes connection to NATS and obtains a JetStream context.
    -   Initializes the `ObjectStore` and `Converter` implementations.
    -   Creates and starts the `NatsWorker` to begin message processing.
    -   Manages graceful shutdown upon receiving OS signals.

### `internal/config`
-   **Purpose**: Defines the service's configuration structure and handles its loading.
-   **Components**:
    -   `NATSConfig`: Holds NATS connection details, subject names, and object store bucket names.
    -   `SoxConfig`: Contains parameters for the `sox` command (e.g., encoding, bits, rate).
    -   `ServiceConfig`: Encapsulates service-specific configurations.
    -   `Config`: The top-level configuration struct.
    -   `Load` function: Uses `configurator.Load` to populate the `Config` struct.

### `internal/converter`
-   **Purpose**: Implements the `core.Converter` interface for PCM to WAV conversion.
-   **Components**:
    -   `SoxConverter`: A struct holding `config.SoxConfig` and a `logger.Logger`.
    -   `New` function: Constructor for `SoxConverter`.
    -   `Process` method: Takes PCM data, creates temporary files, executes the `sox` command with configured arguments, reads the resulting WAV data, and cleans up temporary files.

### `internal/core`
-   **Purpose**: Defines the core interfaces that abstract external dependencies.
-   **Interfaces**:
    -   `ObjectStore`: Defines `Download` and `Upload` methods for interacting with object storage.
    -   `Converter`: Defines a `Process` method for audio format conversion.

### `internal/objectstore`
-   **Purpose**: Implements the `core.ObjectStore` interface using NATS JetStream.
-   **Components**:
    -   `NatsObjectStore`: A struct holding the `nats.JetStreamContext` and bucket names.
    -   `New` function: Constructor for `NatsObjectStore`.
    -   `Download` method: Retrieves data from the configured audio input bucket.
    -   `Upload` method: Stores data into the configured WAV output bucket.

### `internal/worker`
-   **Purpose**: Contains the main NATS message processing logic.
-   **Components**:
    -   `NatsWorker`: A struct holding NATS connection, JetStream context, subject, `ObjectStore`, `Converter`, and `Logger`.
    -   `NewNatsWorker` function: Constructor for `NatsWorker`.
    -   `Run` method: Subscribes to the `AudioChunkCreatedSubject` and starts listening for messages. Handles graceful shutdown of the subscription.
    -   `handleMessage` method: The callback for incoming NATS messages. It parses the `AudioChunkCreatedEvent`, calls `processPCMToWavJob`, and publishes a `WavFileCreatedEvent` as a reply.
    -   `processPCMToWavJob` method: Orchestrates the download of PCM, conversion, and upload of WAV data.
    -   `publishReplyEvent` method: Marshals and sends the `WavFileCreatedEvent` as a NATS reply.
    -   `parseAndValidateEvent` method: Unmarshals and validates the incoming NATS message data into an `AudioChunkCreatedEvent`.

## 5. NATS and JetStream Integration

NATS and JetStream are central to the `pcm-to-wav-service`'s operation:

-   **Messaging**: The service operates on a **request-reply** basis. It subscribes to a NATS subject (defined by `NATSConfig.AudioChunkCreatedSubject`) for `AudioChunkCreatedEvent` messages. Upon successful processing, it publishes a `WavFileCreatedEvent` as a direct **reply** to the original message.
-   **Object Storage**: NATS JetStream is used as the persistent storage for both the input PCM audio chunks and the output WAV files. The service interacts with two distinct JetStream object store buckets:
    -   `NATSConfig.AudioObjectStoreBucket`: For downloading raw PCM data.
    -   `NATSConfig.WavObjectStoreBucket`: For uploading the converted WAV files.

This tight integration allows for a highly scalable, resilient, and decoupled audio processing pipeline, where services communicate asynchronously via events and share data through a distributed object store.

## 6. Error Handling

The service implements robust error handling throughout its components:
-   **Configuration Loading**: Errors from `configurator.Load` are propagated.
-   **NATS Connection**: Failures to connect to NATS or obtain a JetStream context are handled at startup.
-   **Object Store Operations**: Errors during `Download` or `Upload` from JetStream are caught and logged.
-   **Conversion**: `sox` execution errors are captured, logged, and returned.
-   **Message Processing**: The `handleMessage` function logs errors that occur during event parsing or job processing. Since it operates on a request-reply model, if an error occurs, no reply is sent. The responsibility for handling the failure (e.g., via a timeout) lies with the original requester. This is a simpler error handling model than one involving explicit `Ack`/`Nak`/`Term` messages.
-   **Context Cancellation**: `context.Context` is used to manage timeouts for message handling and to enable graceful shutdown.

## 7. Testing

The service includes comprehensive unit tests, particularly for the `converter` and `worker` packages:
-   `internal/converter/converter_test.go`: Tests the `SoxConverter.Process` method, including a check for `sox` availability and verifying that output is generated.
-   `internal/worker/worker_test.go`: Utilizes mock implementations of `ObjectStore` and `Converter` interfaces to test the `NatsWorker`'s message handling logic. It also sets up a temporary NATS server for integration-like testing of message flow. Tests cover successful message processing, event parsing, and reply publication.